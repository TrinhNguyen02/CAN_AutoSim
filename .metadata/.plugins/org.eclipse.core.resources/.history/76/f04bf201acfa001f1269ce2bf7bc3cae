/*
 * motor.c
 *
 *  Created on: Mar 6, 2025
 *      Author: tantr
 */
#include "main.h"
#include "motor.h"

extern motor_t main_motor;
extern uint16_t speed_pulse

float kp = 1;
float ki = 0.1;
float kd = 0.1;

int calc_PID(int input, int set_point, float kp, float ki, float kd)
{
	int error = (int)(set_point - input);
	static int pre_set_point = 0;
	static int pre_error = 0;

	int output = (int)(set_point+ kp*error + kd*(error - pre_error))*100/MAX_SPEED ;

	pre_set_point = set_point;
	pre_error = error;
	output = contraint(output, -100, 100);
	return output;
}

void control_motor(motor_t * motor, uint16_t speed_control, TIM_HandleTypeDef 	* _htim)
{

	speed_pulse = calc_PID(motor->actl_speed, speed_control, kp, ki, kd);
}

void read_enc (motor_t * motor, TIM_HandleTypeDef 	* _htim)
{
	motor->curr_cnt = __HAL_TIM_GET_COUNTER(_htim);
	motor->actl_speed = (int)(motor->curr_cnt - motor->pre_cnt)*(1000/(SAMPLING_ENC * PULSES_ENC));
	motor->pre_cnt = motor->curr_cnt;
}
